<Macro VhostMagento $host $domain>

  Use VhostPhp $host $domain

  <Directory "/var/www/$domain/$host/public">
    <IfModule rewrite_module>
      Options +SymLinksIfOwnerMatch
    </IfModule>
  </Directory>

  # *facepalm* none of this shit should be in the public directory.
  <Directory "/var/www/$domain/$host/public/app">
    Require all denied
  </Directory>

  <Directory "/var/www/$domain/$host/public/dev">
    Require all denied
  </Directory>

  <Directory "/var/www/$domain/$host/public/downloader">
    <FilesMatch "\.(cfg|ini|xml)$">
      Require all denied
    </FilesMatch>
  </Directory>

  <Directory "/var/www/$domain/$host/public/downloader/lib">
    Require all denied
  </Directory>

  <Directory "/var/www/$domain/$host/public/downloader/Maged">
    Require all denied
  </Directory>

  <Directory "/var/www/$domain/$host/public/downloader/template">
    Require all denied
  </Directory>

  <Directory "/var/www/$domain/$host/public/errors">
    <FilesMatch "\.(xml|phtml)$">
      Require all denied
    </FilesMatch>
  </Directory>

  <Directory "/var/www/$domain/$host/public/includes">
    Require all denied
  </Directory>

  <Directory "/var/www/$domain/$host/public/lib">
    Require all denied
  </Directory>

  <Directory "/var/www/$domain/$host/public/media">
    # Don't execute user-uploaded PHP files.
    <IfModule php7_module>
      php_admin_flag engine off
    </IfModule>

    <IfModule rewrite_module>
      Options +SymLinksIfOwnerMatch
      RewriteEngine On

      RewriteCond %{DOCUMENT_ROOT}%{REQUEST_FILENAME} !-f
      RewriteCond %{DOCUMENT_ROOT}%{REQUEST_FILENAME} !-d
      RewriteCond %{DOCUMENT_ROOT}%{REQUEST_FILENAME} !-l

      RewriteRule ^(.*)$ /get.php [L]
    </IfModule>
  </Directory>

  <Directory "/var/www/$domain/$host/public/media/customer">
    Require all denied
  </Directory>

  <Directory "/var/www/$domain/$host/public/media/downloadable">
    Require all denied
  </Directory>

  <Directory "/var/www/$domain/$host/public/pkginfo">
    Require all denied
  </Directory>

  <Directory "/var/www/$domain/$host/public/skin/frontend/rwd/default/scss">
    Require all denied
  </Directory>

  <Directory "/var/www/$domain/$host/public/var">
    Require all denied
  </Directory>

  Use Magento

</Macro>
