<Macro Drupal>

  # Redirect login/admin pages to HTTPS.
  <IfModule rewrite_module>
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule \
      ^/(user|admin) \
      https://%{HTTP_HOST}%{REQUEST_URI} [R=301,QSA,L]
  </IfModule>

  # And fail if the redirect doesn't work.
  <LocationMatch "^/(user|admin)">
    SSLRequireSSL
  </LocationMatch>

  # Protect files and directories from prying eyes.
  <FilesMatch "\.(engine|inc|info|install|module|profile|po|sh|.*sql)$">
    Require all denied
  </FilesMatch>

  # These too.
  <FilesMatch "\.(theme|tpl(\.php)?|xtmpl)$|^(code-style\.pl|Entries.*)$">
    Require all denied
  </FilesMatch>

  # And these.
  <FilesMatch "\.(Repository|Root|Tag|Template)$">
    Require all denied
  </FilesMatch>

  # Clean URLs.
  <IfModule rewrite_module>
    RewriteEngine On
    RewriteCond %{DOCUMENT_ROOT}%{REQUEST_FILENAME} !-f
    RewriteCond %{DOCUMENT_ROOT}%{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ /index.php?q=$1 [L,QSA]
  </IfModule>
</Macro>
