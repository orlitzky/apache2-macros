<Macro CmsSecureLogin>
  # Force SSL for login/admin pages.
  #
  # Should work for CMS Made Simple, Drupal, Wordpress, Joomla, and Magento.
  #
  # This must be included BEFORE drupal.conf, cms_made_simple.conf, or
  # wordpress.conf!
  #
  <IfModule rewrite_module>

    # Drupal / CMS:MS
    RewriteEngine on
    RewriteCond %{HTTPS} off
    RewriteRule \
      ^/(user|admin) \
      https://%{HTTP_HOST}%{REQUEST_URI} [R=301,QSA,L]

    # Wordpress
    #
    # We don't redirect wp-admin/admin-ajax.php to HTTPS because the
    # wp-polls plugin uses it for its AJAX calls. Apparently this is not
    # a bug and is actually part of the Wordpress AJAX API. Ha Ha!
    #
    RewriteCond %{HTTPS} off
    RewriteCond %{REQUEST_URI} !=/wp-admin/admin-ajax.php
    RewriteRule \
      ^/wp\-(admin|login) \
      https://%{HTTP_HOST}%{REQUEST_URI} [R=301,QSA,L]

    # Joomla
    RewriteCond %{HTTPS} off
    RewriteRule \
      ^/administrator \
      https://%{HTTP_HOST}%{REQUEST_URI} [R=301,QSA,L]

    # Magento. If it isn't outputting clean URLs, the paths will be
    # prefixed by "index.php/".
    RewriteCond %{HTTPS} off
    RewriteRule \
      ^/(index\.php)?/(customer|admin) \
      https://%{HTTP_HOST}%{REQUEST_URI} [R=301,QSA,L]

  </IfModule>

  <LocationMatch "^/(user|admin|administrator|customer|wp\-login)">
    # Don't require SSL for /wp-admin since we need to access
    # /wp-admin/admin-ajax.php over plain HTTP.
    SSLRequireSSL
  </LocationMatch>

</Macro>
