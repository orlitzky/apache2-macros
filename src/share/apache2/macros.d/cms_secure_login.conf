<Macro CmsSecureLogin>
  # Force SSL for login/admin pages.
  #
  # Should work for CMS Made simple, Drupal, Wordpress, and Joomla.
  #
  # This must be included BEFORE drupal.conf, cms_made_simple.conf, or
  # wordpress.conf!
  #
  <IfModule rewrite_module>

    # Drupal / CMS:MS
    RewriteEngine on
    RewriteCond %{HTTPS} off
    RewriteRule \
      ^/(user|admin) \
      https://%{HTTP_HOST}%{REQUEST_URI} [R=301,QSA,L]

    # Wordpress
    #
    # We don't redirect wp-admin/admin-ajax.php to HTTPS because the
    # wp-polls plugin uses it for its AJAX calls. Apparently this is not
    # a bug and is actually part of the Wordpress AJAX API. Ha Ha!
    #
    RewriteCond %{HTTPS} off
    RewriteCond %{REQUEST_URI} !=/wp-admin/admin-ajax.php
    RewriteRule \
      ^/wp\-(admin|login) \
      https://%{HTTP_HOST}%{REQUEST_URI} [R=301,QSA,L]

    # This is for the One-click Plugin Updater, which sends you to its
    # do_update.php page under
    # wp-content/plugins/one-click-plugin-updater.  Without this, it
    # will use the site's non-HTTPS URL, and your (secure) login cookie
    # won't work.
    RewriteCond %{HTTPS} off
    RewriteRule \
      ^/wp\-content/plugins/one\-click\-plugin\-updater \
      https://%{HTTP_HOST}%{REQUEST_URI} [R=301,QSA,L]

    # Joomla
    RewriteCond %{HTTPS} off
    RewriteRule \
      ^/administrator \
      https://%{HTTP_HOST}%{REQUEST_URI} [R=301,QSA,L]

  </IfModule>

  <LocationMatch /(user/admin)>
    SSLRequireSSL
  </LocationMatch>

  <LocationMatch /wp\-login>
    # Don't require SSL for /wp-admin since we need to access
    # /wp-admin/admin-ajax.php over plain HTTP.
    SSLRequireSSL
  </LocationMatch>

  <LocationMatch /administrator>
    SSLRequireSSL
  </LocationMatch>

</Macro>
